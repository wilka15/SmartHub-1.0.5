<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SmartHub AI v1.0.4</title>
  <style>
    :root {
      --bg-dark: #0b0f19;
      --text-dark: #eef;
      --bg-light: #f3f3f3;
      --text-light: #111;
      --panel-dark: rgba(255,255,255,0.04);
      --panel-light: rgba(0,0,0,0.04);
      --accent: #00d4ff;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text-dark);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
      align-items: stretch;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel-dark), var(--panel-dark));
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    body.light .panel {
      background: linear-gradient(180deg, var(--panel-light), var(--panel-light));
    }

    .header {
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      color: var(--accent);
    }

    .chat-window {
      background: var(--panel-dark);
      border-radius: 10px;
      padding: 12px;
      flex: 1;
      overflow: auto;
      min-height: 120px;
    }
    body.light .chat-window {
      background: var(--panel-light);
    }

    .msg {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .msg .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      flex: 0 0 54px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 78%;
      line-height: 1.35;
      background: rgba(255,255,255,0.04);
    }
    .msg.user { justify-content: flex-end; flex-direction: row-reverse; }
    .msg.user .bubble {
      background: var(--accent);
      color: #002;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-row input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: rgba(0,0,0,0.2);
      color: inherit;
      outline: none;
    }
    .icon-btn, .small-btn {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 10px;
    }
    .icon-btn {
      width: 48px;
      height: 48px;
      background: var(--accent);
      color: #002;
      font-weight: bold;
    }
    .small-btn {
      width: 44px;
      height: 44px;
      background: #222;
      color: #ddd;
    }

    .settings {
      background: linear-gradient(180deg, var(--panel-dark), var(--panel-dark));
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    body.light .settings {
      background: linear-gradient(180deg, var(--panel-light), var(--panel-light));
    }

    .settings h3 { margin: 0; color: var(--accent); }
    .field { display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
    .switch-label { margin-bottom: 4px; }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 6px;
      font-size: 13px;
      opacity: .85;
    }
    .version { margin-left: auto; }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="header">SmartHub AI</div>
      <div id="chat" class="chat-window" aria-live="polite" role="log"></div>
      <div class="input-row">
        <input id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
        <button class="icon-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        <button class="small-btn" id="micBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        <button class="small-btn" id="speakBtn" title="–û–∑–≤—É—á–∏—Ç—å">üîä</button>
      </div>
      <div class="footer">
        <div class="version">SmartHub AI v1.0.5</div>
      </div>
    </div>

    <aside class="settings" id="settingsPanel">
      <h3>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

      <div class="field">
        <label class="switch-label">–¢–µ–º–∞:</label>
        <label><input type="checkbox" id="themeSwitch"> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</label>
      </div>

      <div class="field">
        <label class="switch-label">–û–∑–≤—É—á–∫–∞:</label>
        <select id="voiceSelect">
          <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          <option value="male">–ú—É–∂—Å–∫–æ–π</option>
        </select>
      </div>

      <div class="field">
        <label class="switch-label">–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <img id="avatarPreview" class="avatar-preview" alt="avatar preview" />
        <div class="avatar-select" id="avatarOptions"></div>
      </div>

      <button id="clearBtn" style="padding:12px;background:#ff7b00;border:none;border-radius:10px;color:#001;font-weight:700;cursor:pointer">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
      <div class="small-muted">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</div>
    </aside>
  </div>

  <script>
    const API_URL = "https://openai-proxy-3.onrender.com/v1/responses";

    let userAvatar = localStorage.getItem('sh_userAvatar') || 'svg:user:1';
    let chatHistory = JSON.parse(localStorage.getItem('sh_chatHistory') || '[]');
    let lastAI = "";

    let voicesList = [];
    let selectedVoiceGender = localStorage.getItem('sh_voice_gender') || 'female';

    const AVATARS = {
      'svg:user:1': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g1' x1='0' x2='1'><stop offset='0' stop-color='#00d4ff'/><stop offset='1' stop-color='#00ffa3'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(#g1)'/><g fill='#001' opacity='0.14'><circle cx='60' cy='44' r='20'/><rect x='20' y='74' width='80' height='28' rx='12'/></g><circle cx='60' cy='44' r='18' fill='#fff' opacity='0.15'/></svg>`,
      'svg:user:2': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='#7b61ff'/><stop offset='1' stop-color='#ff61b8'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(#g2)'/><g fill='#001' opacity='0.14'><circle cx='60' cy='44' r='20'/></g></svg>`,
      'svg:user:3': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g3' x1='0' x2='1'><stop offset='0' stop-color='#ffb86b'/><stop offset='1' stop-color='#ff6b6b'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(#g3)'/></svg>`,
      'svg:ai:1': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><rect width='120' height='120' rx='24' fill='#0de7c9'/><circle cx='36' cy='44' r='18' fill='#fff' opacity='.85'/><circle cx='84' cy='44' r='18' fill='#fff' opacity='.65'/></svg>`
    };

    function svgToDataUrl(svg) {
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function buildAvatarOptions() {
      const container = document.getElementById('avatarOptions');
      container.innerHTML = '';
      Object.keys(AVATARS).forEach(key => {
        if (!key.startsWith('svg:user')) return;
        const img = document.createElement('img');
        img.src = svgToDataUrl(AVATARS[key]);
        img.className = 'avatar-option';
        img.title = key;
        img.addEventListener('click', () => { setUserAvatar(key); });
        container.appendChild(img);
      });
      document.getElementById('avatarPreview').src = svgToDataUrl(AVATARS[userAvatar]);
    }

    const chatEl = document.getElementById('chat');

    function renderMessage(item) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (item.role === 'user' ? 'user' : 'ai');
      const av = document.createElement('div'); av.className = 'avatar';
      const img = document.createElement('img'); img.className = 'avatar-img';
      img.src = item.avatar; img.alt = item.role;
      img.style.width = '54px'; img.style.height = '54px'; img.style.borderRadius = '50%';
      av.appendChild(img);
      const bubble = document.createElement('div'); bubble.className = 'bubble';
      bubble.textContent = item.text;
      wrap.appendChild(av); wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function saveAndRenderMessage(text, role) {
      const avatarData = role === 'user'
        ? svgToDataUrl(AVATARS[userAvatar])
        : svgToDataUrl(AVATARS['svg:ai:1']);
      const item = { text, role, avatar: avatarData, at: Date.now() };
      chatHistory.push(item);
      localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
      renderMessage(item);
    }

    function loadHistory() {
      chatEl.innerHTML = '';
      chatHistory.forEach(renderMessage);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function clearChat() {
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?')) return;
      chatHistory = [];
      localStorage.removeItem('sh_chatHistory');
      chatEl.innerHTML = '';
      lastAI = '';
    }

    function setUserAvatar(key) {
      if (!AVATARS[key]) return;
      userAvatar = key;
      localStorage.setItem('sh_userAvatar', userAvatar);
      buildAvatarOptions();
    }

    function speakText(text) {
      if (!text) return;
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);

      const pref = document.getElementById('voiceSelect').value;
      let voice = voicesList.find(v => {
        if (pref === 'male') return /male|man/i.test(v.name);
        else return /female|woman/i.test(v.name);
      });

      // –µ—Å–ª–∏ –Ω–µ –Ω–∞—à—ë–ª –ø–æ–¥—Ö–æ–¥—è—â–∏–π ‚Äî –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–π –≥–æ–ª–æ—Å
      if (!voice && voicesList.length > 0) voice = voicesList[0];
      utter.voice = voice;

      localStorage.setItem('sh_voice_gender', pref);

      synth.cancel();
      synth.speak(utter);
    }

    function startSpeechToText() {
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Rec) { alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
      const r = new Rec();
      r.lang = 'ru-RU';
      r.onresult = e => {
        document.getElementById('userInput').value = e.results[0][0].transcript;
      };
      r.start();
    }

    async function sendToProxy(text) {
      saveAndRenderMessage('...', 'ai');
      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'gpt-4o-mini', input: text })
        });
        const data = await resp.json();
        let answer = null;
        if (data.output && data.output[0]?.content) {
          const chunks = data.output[0].content;
          const textChunk = chunks.find(c => c.text) || chunks[0];
          answer = textChunk.text || textChunk.content || '';
        } else if (data.choices && data.choices[0]?.message) {
          answer = data.choices[0].message.content;
        } else if (typeof data === 'string') {
          answer = data;
        } else {
          answer = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞';
        }

        chatHistory.pop();
        localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
        saveAndRenderMessage(answer, 'ai');
        lastAI = answer;
      } catch (err) {
        chatHistory.pop();
        localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
        saveAndRenderMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'ai');
        console.error(err);
      }
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
      const t = document.getElementById('userInput').value.trim();
      if (!t) return;
      document.getElementById('userInput').value = '';
      saveAndRenderMessage(t, 'user');
      sendToProxy(t);
    });

    document.getElementById('userInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); document.getElementById('sendBtn').click(); }
    });

    document.getElementById('micBtn').addEventListener('click', startSpeechToText);
    document.getElementById('clearBtn').addEventListener('click', clearChat);
    document.getElementById('speakBtn').addEventListener('click', () => speakText(lastAI));

    const themeSwitch = document.getElementById('themeSwitch');
    themeSwitch.addEventListener('change', () => {
      const on = themeSwitch.checked;
      document.body.classList.toggle('light', on);
      localStorage.setItem('sh_theme_is_light', on ? '1' : '0');
    });

    (function init() {
      loadHistory();
      buildAvatarOptions();

      const savedTheme = localStorage.getItem('sh_theme_is_light') === '1';
      themeSwitch.checked = savedTheme;
      document.body.classList.toggle('light', savedTheme);

      voicesList = window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        voicesList = window.speechSynthesis.getVoices();
      };

      const vsel = document.getElementById('voiceSelect');
      vsel.value = localStorage.getItem('sh_voice_gender') || 'female';
    })();

  </script>
</body>
</html>
